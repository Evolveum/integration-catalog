{
	"files": [
        {
            "path": "connector.manifest.json",
            "content": "{\n    \"application\": {\n        \"name\": \"Gitlab\",\n        \"description\": \"Powerful classic, agile or hybrid project management in a secure environment.\"\n    },\n    \"connector\": {\n        \"groupId\": \"com.evolveum.polygon\",\n        \"artifactId\": \"gitlab\",\n        \"version\": \"1.3.9.11\",\n        \"template\": {\n            \"groupId\": \"com.evolveum.polygon.scimrest\",\n            \"artifactId\": \"connector-scimrest-generic\",\n            \"version\": \"0.1-SNAPSHOT\"\n        },\n        \"schema\": [\n            {\n                \"script\": \"User.connid.schema.groovy\"\n            },\n            {\n                \"script\": \"User.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Group.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Group.connid.schema.groovy\"\n            },\n            {\n                \"script\": \"Project.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Project.connid.schema.groovy\"\n            },\n            {\n                \"script\": \"Role.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Role.connid.schema.groovy\"\n            },\n            {\n                \"script\": \"Formattable.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Membership.native.schema.groovy\"\n            },\n            {\n                \"script\": \"Membership.connid.schema.groovy\"\n            },\n            {\n                \"script\": \"associations.schema.groovy\"\n            }\n        ],\n        \"operation\": [\n            {\n                \"script\": \"authorization.op.groovy\"\n            },\n            {\n                \"script\": \"User.search.groovy\"\n            },\n            {\n                \"script\": \"Group.search.groovy\"\n            },\n            {\n                \"script\": \"Project.search.groovy\"\n            },\n            {\n                \"script\": \"Role.search.groovy\"\n            },\n            {\n                \"script\": \"Membership.search.groovy\"\n            }\n        ],\n                \"capability\" : [\"ScriptOnConnector\", \"Get\", \"Sync\", \"Schema\", \"Test\", \"Validate\", \"Search\"]\n    }\n}\n"

        },
        {
            "path": "META-INF/MANIFEST.MF",
            "content": "Manifest-Version: 1.0\nCreated-By: Maven Archiver 3.6.0\nBuild-Jdk-Spec: 21\nConnectorBundle-ConnectorClass: com.evolveum.polygon.scimrest.groovy.impl.ManifestBasedConnector\nConnectorBundle-FrameworkVersion: 1.7.0.0-SNAPSHOT\nConnectorBundle-Name: com.evolveum.polygon.scimrest.gitlab\nConnectorBundle-Version: 1.3\n\n"
        },
        {
            "path": "configurationOverride.properties",
            "content": ""
        },
        {
            "path": "Messages.properties",
            "content": "#Tue Oct 07 15:50:56 CEST 2025\nmanifest.connector.display=Gitlab Connector\nrest=REST\nrest.baseAddress=REST Base Address\nrest.address.test=Test Endpoint\nrest.auth.apiKey=REST API Key\nrest.auth.password=REST Password\nrest.auth.tokenName=REST Authentication Token Name\nrest.auth.tokenValue=REST Authentication Token\nrest.auth.username=REST Username\nscim=SCIM\nscim.address.base=SCIM 2.0 Base Address\nscim.auth.tokenValue=SCIM 2.0 Authentication Token\nrest.trustAllCertificates=Trust All Certificates\n"
        },
		{
            "path": "associations.schema.groovy",
            "content": "import org.identityconnectors.framework.common.objects.ConnectorObjectBuilder\nimport org.identityconnectors.framework.common.objects.ConnectorObjectReference\nimport org.identityconnectors.framework.common.objects.ObjectClass\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nrelationship(\"UserProjectMembership\") {\n    subject(\"User\") {\n        attribute(\"memberships\") {\n            multiValued true\n            resolver {\n                resolutionType PER_OBJECT\n                search {\n                    attributeFilter(\"principal\").eq(value)\n                }\n            }\n        }\n    }\n    object(\"Membership\") {\n        attribute(\"principal\")\n    }\n}\nrelationship(\"MembershipProject\") {\n\n    subject(\"Membership\") {\n        attribute(\"project\") {\n            //objectClass \"Project\"\n            json {\n                path attribute(\"_links\").child(\"project\")\n                implementation {\n                    deserialize {\n                        if(it == null){\n                            it = value\n                        }\n                        var href = it.get(\"href\")?.asText();\n                        var pid = href.substring(href.lastIndexOf(\"/\") + 1)\n\n                        var obj = new ConnectorObjectBuilder()\n                                .setObjectClass(new ObjectClass(\"Project\"))\n                                .setUid(pid)\n                                .setName(it.get(\"title\")?.asText())\n                        return new ConnectorObjectReference(obj.build());\n                    }\n                }\n            }\n        }\n    }\n    object(\"Project\") {\n        attribute(\"memberships\") {\n            // FIXME: Add implementation\n        }\n    }\n}\n\nrelationship(\"MembershipRole\") {\n    subject(\"Membership\") {\n        attribute(\"roles\") {\n\n        }\n    }\n    object(\"Role\") {\n        attribute(\"memberships\") {\n\n        }\n    }\n\n}"
        },
        {
            "path": "authorization.op.groovy",
            "content": "authentication {\n    rest {\n        basic {\n            request.header(\"Authorization\", \"Basic \" +\n                    Base64.getEncoder().encodeToString((configuration.getRestUsername() +\n                            \":\" + decrypt(configuration.getRestPassword()))).getBytes())\n        }\n    }\n}\n"
        },
        {
            "path": "Formattable.native.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Formattable\") {\n    embedded true\n    description \"Projects are containers structuring the information (e.g. work packages, wikis) into smaller groups.\"\n\n    attribute(\"format\") {\n        jsonType \"string\";\n        returnedByDefault true;\n        description \"Indicates the formatting language of the raw text\"\n    }\n    attribute(\"raw\") {\n        jsonType \"string\"\n        description \"The raw text, as entered by the user\"\n        returnedByDefault true;\n    }\n    attribute(\"html\") {\n        jsonType \"string\"\n        description \"The text converted to HTML according to the format\"\n        returnedByDefault true\n    }\n}"
        },
        {
            "path": "Group.connid.schema.groovy",
            "content": "\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Group\") {\n    connIdAttribute(\"UID\", \"id\");\n    connIdAttribute(\"NAME\", \"name\");\n}"
        },
        {
            "path": "Group.native.schema.groovy",
            "content": "import org.identityconnectors.framework.common.objects.ConnectorObjectBuilder\nimport org.identityconnectors.framework.common.objects.ConnectorObjectReference\nimport org.identityconnectors.framework.common.objects.ObjectClass\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Group\") {\n    description \"Team represents a team in an organization\"\n\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required true;\n        description \"User’s id\";\n    }\n    attribute(\"name\") {\n        jsonType \"string\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required true;\n        description \"Group’s full name, formatting depends on instance settings\";\n    }\n    attribute(\"created_at\") {\n        jsonType \"string\"\n        openApiFormat \"date-time\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required false;\n        description \"Time of creation\";\n    }\n    attribute(\"updated_at\") {\n        jsonType \"string\"\n        openApiFormat \"date-time\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required false;\n        description \"Time of the most recent change to the user\";\n    }\n    reference(\"members\") {\n        description(\"The list all all the users that are members of the group\")\n        objectClass \"User\"\n\n        json {\n            path attribute(\"_links\").child(\"members\")\n            implementation {\n                deserialize {\n\n                    var href = value.get(\"href\")?.asText();\n                    var pid = href.substring(href.lastIndexOf(\"/\") + 1)\n\n                    var obj = new ConnectorObjectBuilder()\n                            .setObjectClass(new ObjectClass(\"User\"))\n                            .setUid(pid)\n                            .setName(value.get(\"title\")?.asText())\n                    return new ConnectorObjectReference(obj.build());\n                }\n            }\n        }\n    }\n}"
        },
        {
            "path": "Group.project.support.search.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nimport java.nio.charset.StandardCharsets\n\nobjectClass(\"Group\") {\n    search {\n        endpoint(\"projects/\") {\n            responseFormat JSON_ARRAY\n            pagingSupport { // IDEA: lambda may delegate also to RequestBuilder\n                request.queryParameter(\"limit\", paging.pageSize)\n                        .queryParameter(\"page\", paging.pageOffset)\n            }\n            supportedFilter(attribute(\"project\").eq().anySingleValue()) {\n\n                String filter = \"[{ \\\\\"principal\\\\\": { \\\\\"operator\\\\\": \\\\\"=\\\\\", \\\\\"values\\\\\": [\\\\\"${value.value.uid}\\\\\"] } }]\"\n                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n            }\n        }\n    }\n}"
        },
        {
            "path": "Group.search.groovy",
            "content": "import org.json.JSONArray\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Group\") {\n\n    search {\n        endpoint(\"groups/\") {\n            objectExtractor {\n\n                if(response.body()==null){\n                    return new JSONArray();\n                }\n\n                return response.body().get(\"_embedded\").get(\"elements\");\n            }\n            emptyFilterSupported true\n        }\n        endpoint(\"groups/{id}\") {\n            singleResult()\n            supportedFilter(attribute(\"id\").eq().anySingleValue()) {\n                request.pathParameter(\"id\", value)\n            }\n        }\n    }\n}"
        },
        {
            "path": "Membership.connid.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Membership\") {\n    connIdAttribute(\"UID\", \"id\");\n    connIdAttribute(\"NAME\", \"name\");\n}\n"
        },
        {
            "path": "Membership.native.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\n\nimport org.identityconnectors.framework.common.objects.ConnectorObjectBuilder\nimport org.identityconnectors.framework.common.objects.ConnectorObjectReference\nimport org.identityconnectors.framework.common.objects.ObjectClass\n\nobjectClass(\"Membership\") {\n    embedded(true);\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        returnedByDefault true;\n        required true;\n        description \"Membership id\";\n    }\n    attribute(\"name\") {\n        json {\n            type \"integer\"\n            name \"id\"\n        };\n        readable true;\n        returnedByDefault true;\n        required true;\n        description \"Membership name (copy of id)\";\n    }\n\n    attribute(\"createdAt\") {\n        jsonType \"string\";\n        openApiFormat \"date-time\"\n        readable true;\n        returnedByDefault true;\n        description \"Time of creation\";\n    }\n\n    attribute(\"updatedAt\") {\n        jsonType \"string\";\n        openApiFormat \"date-time\"\n        readable true;\n        returnedByDefault true;\n        description \"Time of latest update\";\n    }\n\n//    attribute(\"principal\") {\n//\n//        json {\n//            path attribute(\"_links\").child(\"principal\")\n//        }\n//\n//        complexType \"Principal\"\n//        readable true;\n//        updateable false;\n//        creatable true;\n//        returnedByDefault true;\n//        required true;\n//    }\n\n    reference(\"principal\") {\n        objectClass \"Principal\"\n\n        json {\n            path attribute(\"_links\").child(\"principal\")\n            implementation {\n                deserialize {\n\n                    var href = value.get(\"href\")?.asText();\n                    var pid = href.substring(href.lastIndexOf(\"/\") + 1)\n\n                    var obj = new ConnectorObjectBuilder()\n                            .setObjectClass(new ObjectClass(\"Principal\"))\n                            .setUid(pid)\n                            .setName(value.get(\"title\")?.asText())\n                    return new ConnectorObjectReference(obj.build());\n                }\n            }\n        }\n    }\n\n    reference(\"roles\") {\n        objectClass \"Role\"\n\n        json {\n            path attribute(\"_links\").child(\"roles\")\n            implementation {\n                deserialize {\n                    if(it == null){\n                        it = value;\n                    }\n                    var obj = new ConnectorObjectBuilder()\n                            .setObjectClass(new ObjectClass(\"Role\"))\n                            .setUid(it.get(\"href\")?.asText())\n                            .setName(it.get(\"title\")?.asText())\n                    return new ConnectorObjectReference(obj.build());\n                }\n            }\n        }\n    }\n\n    reference(\"project\") {\n        objectClass \"Project\"\n//        relationship(\"MembershipProject\"){\n//            subject(\"Membership\"){}\n//            object(\"Project\"){}\n//        }\n        json {\n            path attribute(\"_links\").child(\"project\")\n            implementation {\n                deserialize {\n\n                    if(it == null){\n                        it = value;\n                    }\n                    var href = it.get(\"href\")?.asText();\n                    var pid = href.substring(href.lastIndexOf(\"/\") + 1)\n\n                    var obj = new ConnectorObjectBuilder()\n                            .setObjectClass(new ObjectClass(\"Project\"))\n                            .setUid(pid)\n                            .setName(it.get(\"title\")?.asText())\n                    return new ConnectorObjectReference(obj.build());\n                }\n            }\n        }\n    }\n}\n"
        },
        {
            "path": "Membership.search.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nimport org.identityconnectors.framework.common.objects.ConnectorObject\nimport org.json.JSONArray\n\nimport java.nio.charset.StandardCharsets\n\n\nobjectClass(\"Membership\") {\n    search {\n        normalize {\n            toSingleValue \"roles\"\n            rewriteUid {\n                if(value == null\n                ){\n                    return original;\n                }\n                def ref = (ConnectorObject) value.getValue()\n                return original + \":\" + ref.uid.uidValue\n            }\n            rewriteName {\n                if(value == null\n                ){\n                    return original\n                }\n                def ref = (ConnectorObject) value.getValue()\n                return original + \":\" + ref.name.nameValue\n            }\n            restoreUid {\n                return original.substring(0, original.indexOf(\":\"));\n            }\n            restoreName {\n\n                return original.substring(0, original.indexOf(\":\"));\n            }\n        }\n\n        endpoint(\"memberships\") {\n            objectExtractor {\n\n                if(response.body()==null){\n                    return new JSONArray();\n                }\n\n                var jsonArray = response.body().get(\"_embedded\").get(\"elements\");\n                return jsonArray;\n            }\n            pagingSupport {\n                request.queryParameter(\"pageSize\", paging.pageSize)\n                        .queryParameter(\"offset\", paging.pageOffset)\n            }\n            emptyFilterSupported true\n\n            supportedFilter(attribute(\"principal\").eq().anySingleValue()) {\n\n                var valList = value.value.uid.getValue();\n                var val =  valList.get(0);\n\n                // [{\"principal\":{\"operator\":\"=\",\"values\":[\"2273\"]}}]\n                String filter = \"[{\\\\\"principal\\\\\":{\\\\\"operator\\\\\":\\\\\"=\\\\\",\\\\\"values\\\\\":[\\\\\"${val}\\\\\"]}}]\"\n                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n            }\n\n        }\n        endpoint(\"memberships/{id}\") {\n            singleResult()\n            supportedFilter(attribute(\"id\").eq().anySingleValue()) {\n                request.pathParameter(\"id\", value)\n            }\n        }\n    }\n}"
        },
        {
            "path": "Principal.native.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\n\nobjectClass(\"Principal\") {\n    description(\"Principals are the superclass of users, groups and placeholder users\")\n    embedded true\n    attribute(\"name\") {\n        jsonType \"string\";\n        readable true;\n        returnedByDefault true;\n    }\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        returnedByDefault true;\n        required true;\n        description \"User’s id\";\n    }\n\n//    attribute(\"href\") {\n//        jsonType \"string\";\n//        readable true;\n//        returnedByDefault true;\n//    }\n//    attribute(\"title\") {\n//        jsonType \"string\";\n//        readable true;\n//        returnedByDefault true;\n//        required true;\n//        description \"User’s id\";\n//    }\n}\n"
        },
        {
            "path": "Project.connid.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Project\") {\n    connIdAttribute(\"UID\", \"id\");\n    connIdAttribute(\"NAME\", \"name\");\n}\n"
        },
        {
            "path": "Project.native.schema.groovy",
            "content": "import org.identityconnectors.framework.common.objects.AttributeInfo\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Project\") {\n    description \"Projects are containers structuring the information (e.g. work packages, wikis) into smaller groups.\"\n\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required true;\n        description \"Projects’ id\";\n    }\n    attribute(\"name\") {\n        jsonType \"string\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required true;\n        description \"Group’s full name, formatting depends on instance settings\";\n    }\n    attribute(\"created_at\") {\n        jsonType \"string\"\n        openApiFormat \"date-time\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required false;\n        description \"Time of creation\";\n    }\n    attribute(\"updated_at\") {\n        jsonType \"string\"\n        openApiFormat \"date-time\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required false;\n        description \"Time of the most recent change to the project\";\n    }\n\n    attribute(\"identifier\") {\n        jsonType \"string\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required true;\n    }\n\n    attribute(\"active\") {\n        jsonType \"boolean\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required false;\n        description \"Indicates whether the project is currently active or already archived\";\n    }\n\n\n    attribute(\"statusExplanation\") {\n        complexType \"Formattable\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required false;\n    }\n\n    attribute(\"public\") {\n        jsonType \"boolean\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required false;\n        description \"Indicates whether the project is accessible for everybody\";\n    }\n\n\n    attribute(\"description\") {\n\n        complexType \"Formattable\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required false;\n    }\n\n}"
        },
        {
            "path": "Project.search.groovy",
            "content": "import org.json.JSONArray\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\n\nobjectClass(\"Project\") {\n\n    search {\n        endpoint(\"projects/\") {\n            objectExtractor {\n                if(response.body()==null){\n                    return new JSONArray();\n                }\n\n                var jsonArray = response.body().get(\"_embedded\").get(\"elements\");\n                return jsonArray;\n            }\n            pagingSupport {\n                request.queryParameter(\"pageSize\", paging.pageSize)\n                        .queryParameter(\"offset\", paging.pageOffset)\n            }\n            emptyFilterSupported true\n\n        }\n\n        endpoint(\"projects/{id}\") {\n            singleResult()\n            supportedFilter(attribute(\"id\").eq().anySingleValue()) {\n                request.pathParameter(\"id\", value)\n            }\n        }\n    }\n}"
        },
        {
            "path": "Role.connid.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Role\") {\n    connIdAttribute(\"UID\", \"id\");\n    connIdAttribute(\"NAME\", \"name\");\n}\n"
        },
        {
            "path": "Role.native.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Role\") {\n    description \"When principals (groups or users) are assigned to a project, they are receive roles in that project.\"\n\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        required true;\n        description \"Role id\";\n    }\n    attribute(\"name\") {\n        jsonType \"string\"\n        readable true;\n        updateable true;\n        creatable true;\n        returnedByDefault true;\n        required true;\n        description \"Group’s full name, formatting depends on instance settings\";\n    }\n}"
        },
        {
            "path": "Role.search.groovy",
            "content": "import org.json.JSONArray\n\n/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"Role\") {\n\n    search {\n        endpoint(\"roles/\") {\n            objectExtractor {\n\n                if(response.body()==null){\n                    return new JSONArray();\n                }\n\n                var jsonArray = response.body().get(\"_embedded\").get(\"elements\");\n                return jsonArray;\n            }\n            emptyFilterSupported true\n        }\n\n        endpoint(\"roles/{id}\") {\n            singleResult()\n            supportedFilter(attribute(\"id\").eq().anySingleValue()) {\n                request.pathParameter(\"id\", value)\n            }\n        }\n    }\n}"
        },
        {
            "path": "User.connid.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"User\") {\n    connIdAttribute(\"UID\", \"id\");\n    connIdAttribute(\"NAME\", \"login\");\n}\n"
        },
        {
            "path": "User.group.support.search.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\n\nimport java.nio.charset.StandardCharsets\n\n// TODO pseudocode\n//objectClass(\"User\") {\n//    search {\n//        attributeResolver {\n//            attribute \"group\"\n//            resolutionType PER_OBJECT\n//            implementation {\n//                var groups = objectClass(\"Group\").searchAll()\n//                var userGroups  = new ArrayList()\n//                for (var g : groups) {\n//\n//                    // TODO pseudocode, i.e. complex attr value fetch\n//                    var oId =  g.members.id;\n//                    var oType =  g.members._type;\n//\n//                    if(\"User\".equals(oType)){\n//                        if(value.value.uid.equals(oId)){\n//                            userGroups.add(g);\n//                            continue;\n//                        }\n//                    }\n//                }\n//                value.addAttribute(\"group\", userGroups)\n//            }\n//        }\n//    }\n//}\n\n\nobjectClass(\"Group\") {\n    search {\n        endpoint(\"users/\") {\n            responseFormat JSON_ARRAY\n            pagingSupport { // IDEA: lambda may delegate also to RequestBuilder\n                request.queryParameter(\"limit\", paging.pageSize)\n                        .queryParameter(\"page\", paging.pageOffset)\n            }\n            supportedFilter(attribute(\"group\").eq().anySingleValue()) {\n                String filter = \"[{ \\\\\"group\\\\\": { \\\\\"operator\\\\\": \\\\\"=\\\\\", \\\\\"values\\\\\": [\\\\\"${value.value.uid}\\\\\"] } }]\"\n                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n            }\n        }\n    }\n}"
        },
        {
            "path": "User.native.schema.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\nobjectClass(\"User\") {\n    attribute(\"admin\") {\n        jsonType \"boolean\";\n        updateable true;\n        creatable false;\n        readable true;\n        returnedByDefault true;\n        description \"Flag indicating whether or not the user is an admin\";\n    }\n    attribute(\"avatar\") {\n        jsonType \"string\";\n        openApiFormat \"uri\";\n        updateable false;\n        creatable false;\n        readable true;\n        returnedByDefault true;\n        description \"URL to user’s avatar\";\n    }\n\n    attribute(\"created_at\") {\n        jsonType \"string\";\n        openApiFormat \"date-time\";\n        readable true;\n        updateable false;\n        creatable false;\n        returnedByDefault true;\n        description \"Time of creation\";\n    }\n    attribute(\"email\") {\n        jsonType \"string\";\n        openApiFormat \"email\";\n        updateable true;\n        creatable false;\n        readable true;\n        returnedByDefault true;\n        description \"User’s email address\";\n    }\n    attribute(\"firstName\") {\n        jsonType \"string\";\n        updateable true;\n        creatable true;\n        readable true;\n        returnedByDefault true;\n        description \"User’s first name\";\n    }\n\n    attribute(\"id\") {\n        jsonType \"integer\";\n        readable true;\n        returnedByDefault true;\n        required true;\n        description \"User’s id\";\n    }\n\n    attribute(\"identity_url\") {\n        jsonType \"string\";\n        updateable true;\n        creatable true;\n        readable true;\n        returnedByDefault true;\n        description \"User’s identity_url for OmniAuth authentication\";\n    }\n    attribute(\"language\") {\n        jsonType \"string\";\n        creatable true;\n        updateable true;\n        readable true;\n        returnedByDefault true;\n        description \"User’s language\";\n    }\n    attribute(\"lastName\") {\n        jsonType \"string\";\n        creatable true;\n        updateable true;\n        readable true;\n        returnedByDefault true;\n        description \"User’s last name\";\n    }\n\n    attribute(\"login\") {\n        jsonType \"string\";\n        creatable true;\n        updateable true;\n        readable true;\n        returnedByDefault true;\n        required true;\n        description \"User’s login name\";\n    }\n    //TODO association ....\n//    attribute(\"memberships\") {\n//        jsonType \"reference\";\n//        description \"An href to the collection of the principal's memberships.\";\n//    }\n    attribute(\"name\") {\n        jsonType \"string\";\n        readable true;\n        returnedByDefault true;\n        description \"User’s full name, formatting depends on instance settings\";\n    }\n    attribute(\"password\") {\n        jsonType \"string\";\n        updateable true;\n        creatable true;\n        readable true;\n        returnedByDefault false;\n        description \"User’s password for the default password authentication\";\n    }\n    //TODO complex type??? ....\n//    attribute(\"status\") {\n//        jsonType \"status\";\n//        readable true;\n//        returnedByDefault true;\n//        description \"The current activation status of the user (see below)\";\n//    }\n    attribute(\"updated_at\") {\n        jsonType \"string\";\n        openApiFormat \"date-time\"\n        readable true;\n        returnedByDefault true;\n        description \"Time of the most recent change to the user\";\n    }\n}\n"
        },
        {
            "path": "User.search.groovy",
            "content": "/*\n * Copyright (c) 2025 Evolveum and contributors\n *\n * This work is licensed under European Union Public License v1.2. See LICENSE file for details.\n *\n */\n\nimport org.json.JSONArray\n\nimport java.nio.charset.StandardCharsets\nobjectClass(\"User\") {\n    search {\n\n        endpoint(\"users/\") {\n            objectExtractor {\n                if(response.body()==null){\n                    return new JSONArray();\n                }\n\n                var jsonArray = response.body().get(\"_embedded\").get(\"elements\");\n                return jsonArray;\n            }\n            pagingSupport {\n                request.queryParameter(\"pageSize\", paging.pageSize)\n                        .queryParameter(\"offset\", paging.pageOffset)\n            }\n            emptyFilterSupported true\n            supportedFilter(attribute(\"name\").eq().anySingleValue()) {\n                String filter = \"[{ \\\\\"name\\\\\": { \\\\\"operator\\\\\": \\\\\"=\\\\\", \\\\\"values\\\\\": [\\\\\"${value}\\\\\"] } }]\"\n                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n            }\n            supportedFilter(attribute(\"name\").contains().anySingleValue()) {\n\n                String filter = \"[{ \\\\\"name\\\\\": { \\\\\"operator\\\\\": \\\\\"~\\\\\", \\\\\"values\\\\\": [\\\\\"${value}\\\\\"] } }]\"\n                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n            }\n// TODO connid error, operations not supported for __NAME attr\n//            supportedFilter(attribute(\"login\").eq().anySingleValue()) {\n//\n//                String filter = \"[{ \\\\\"login\\\\\": { \\\\\"operator\\\\\": \\\\\"=\\\\\", \\\\\"values\\\\\": [\\\\\"${value}\\\\\"] } }]\"\n//                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n//            }\n//            supportedFilter(attribute(\"login\").contains().anySingleValue()) {\n//\n//                String filter = \"[{ \\\\\"login\\\\\": { \\\\\"operator\\\\\": \\\\\"&=\\\\\", \\\\\"values\\\\\": [\\\\\"${value}\\\\\"] } }]\"\n//                request.queryParameter(\"filters\", URLEncoder.encode(filter, StandardCharsets.UTF_8.toString()))\n//            }\n\n// TODO complex attrs\n//            supportedFilter(attribute(\"status\").contains().anySingleValue()) {\n//                request.queryParameter(\"filters\",value)\n//            }\n//            supportedFilter(attribute(\"status\").eq().anySingleValue()) {\n//                request.queryParameter(\"filters\",value)\n//            }\n//            supportedFilter(attribute(\"group\").eq().anySingleValue()) {\n//                request.queryParameter(\"filters\",value)\n//            }\n//            supportedFilter(attribute(\"group\").contains().anySingleValue()) {\n//                request.queryParameter(\"filters\",value)\n//            }\n        }\n        endpoint(\"users/{id}\") {\n            singleResult()\n            supportedFilter(attribute(\"id\").eq().anySingleValue()) {\n                request.pathParameter(\"id\", value)\n            }\n        }\n    }\n}"
        }
    ]
}