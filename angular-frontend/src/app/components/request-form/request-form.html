<!--
 * Copyright (c) 2010-2025 Evolveum and contributors
 *
 * Licensed under the EUPL-1.2 or later.
 -->

<!-- Success Toast Notification -->
@if (submitSuccess()) {
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 2000;">
    <div style="border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); min-width: 350px;">
      <!-- Green header row -->
      <div class="d-flex justify-content-between align-items-center px-3 py-2" style="background-color: #198754; color: white;">
        <div class="d-flex align-items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
          </svg>
          <strong>Request Successful!</strong>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="closeSuccessMessage()" aria-label="Close"></button>
      </div>
      <!-- Light green message row -->
      <div class="px-3 py-2" style="background-color: #d1e7dd; color: black;">
        Your request has been submitted. Our team will review it and get back to you.
      </div>
    </div>
  </div>
}

<!-- Request Tailored Solution Modal -->
@if (isRequestModalOpen()) {
  <div class="modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1040;" (click)="closeRequestModal()"></div>
  <div class="modal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; overflow: auto;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px; margin: auto;">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header" style="border-bottom: 1px solid #dee2e6; padding: 1rem 1.5rem;">
          <h6 class="modal-title mb-0">Request Tailored Solution</h6>
          <button type="button" class="btn-close" (click)="closeRequestModal()" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="padding: 1.5rem;">
          <!-- Row 1 -->
          <h6 class="mb-2">Didn't find the integration you need?</h6>

          <!-- Row 2 -->
          <p class="text-muted mb-4">Tell us what you're looking for and we'll help you connect it.</p>

          <!-- Row 3 & 4 -->
          <div class="mb-3">
            <label class="form-label">
              Integration Application Name*
              <button type="button" class="btn btn-link p-0 ms-1" style="border: none;" title="Application name information">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16" style="color: #6ea8fe;">
                  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                </svg>
              </button>
            </label>
            <input type="text" class="form-control" [(ngModel)]="formData.integrationApplicationName" required>
          </div>

          <!-- Row 5 -->
          <div class="mb-3">
            <label class="form-label">
              Base URL Application (Optional)
              <button type="button" class="btn btn-link p-0 ms-1" style="border: none;" title="Base URL information">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16" style="color: #6ea8fe;">
                  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                </svg>
              </button>
            </label>
            <input type="url" class="form-control" [(ngModel)]="formData.baseUrl">
          </div>

          <!-- Row 6 & 7 -->
          <div class="mb-3">
            <label class="form-label">
              Requested Capabilities
              <button type="button" class="btn btn-link p-0 ms-1" style="border: none;" title="Capabilities information">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16" style="color: #6ea8fe;">
                  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                </svg>
              </button>
            </label>

            <!-- Custom dropdown field -->
            <div class="position-relative">
              <div class="form-control d-flex flex-wrap align-items-center gap-1"
                   (click)="toggleCapabilitiesDropdown()"
                   style="min-height: 38px; cursor: pointer; padding: 0.375rem 2.25rem 0.375rem 0.75rem;">

                @if (selectedCapabilities().length === 0) {
                  <span style="color: #6c757d;">Select</span>
                } @else {
                  @for (capability of selectedCapabilities(); track capability) {
                    <span class="badge" style="background-color: #cfe2ff; color: black; font-size: 0.875rem;">
                      {{ capability }}
                      <button type="button" class="btn-close btn-close-sm ms-1" (click)="removeCapability(capability, $event)"
                              style="font-size: 0.75rem; vertical-align: middle;" aria-label="Remove"></button>
                    </span>
                  }
                }

                <!-- Dropdown arrow -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi position-absolute top-50 end-0 translate-middle-y me-2"
                     [style.transform]="isCapabilitiesDropdownOpen() ? 'translateY(-50%) rotate(180deg)' : 'translateY(-50%)'"
                     style="transition: transform 0.2s;" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708"/>
                </svg>
              </div>

              <!-- Dropdown menu with checkboxes -->
              @if (isCapabilitiesDropdownOpen()) {
                <div class="position-absolute w-100 border rounded bg-white shadow-sm mt-1"
                     style="z-index: 1000; max-height: 300px; overflow-y: auto;">
                  <div class="p-3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-paged-search" (change)="onCapabilityChange($event, 'Paged Search')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Paged Search</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-live-sync" (change)="onCapabilityChange($event, 'Live Sync')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Live Sync</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-read-access" (change)="onCapabilityChange($event, 'Read Access')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Read Access</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-update-data" (change)="onCapabilityChange($event, 'Update Data')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Update Data</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-create-entry" (change)="onCapabilityChange($event, 'Create Entry')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Create Entry</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-test-connection" (change)="onCapabilityChange($event, 'Test Connection')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Test Connection</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-auxiliary-object-classes" (change)="onCapabilityChange($event, 'Auxiliary Object Classes')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Auxiliary Object Classes</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-script-execution" (change)="onCapabilityChange($event, 'Script Execution')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Script Execution</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-password-security" (change)="onCapabilityChange($event, 'Password Security')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>Password Security</span>
                    </label>
                    <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
                      <input class="me-2" type="checkbox" id="capability-user-credentials" (change)="onCapabilityChange($event, 'User Credentials')"
                             style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                      <span>User Credentials</span>
                    </label>
                  </div>

                  <!-- Close button -->
                  <div class="border-top p-2 text-end">
                    <button type="button" class="btn btn-sm btn-primary" (click)="closeCapabilitiesDropdown()">Done</button>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Row 8 & 9 -->
          <div class="mb-3">
            <label class="form-label">Short description*</label>
            <textarea class="form-control" rows="3" [(ngModel)]="formData.description" placeholder="Briefly describe the integration you need and your use case." required></textarea>
          </div>

          <!-- Row 10 & 11 -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">
                System Version (Optional)
                <button type="button" class="btn btn-link p-0 ms-1" style="border: none;" title="System version information">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16" style="color: #6ea8fe;">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                  </svg>
                </button>
              </label>
              <input type="text" class="form-control" [(ngModel)]="formData.systemVersion">
            </div>
            <div class="col-md-6">
              <label class="form-label">
                Your Contact Email (Optional)
                <button type="button" class="btn btn-link p-0 ms-1" style="border: none;" title="Contact email information">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle-fill" viewBox="0 0 16 16" style="color: #6ea8fe;">
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2"/>
                  </svg>
                </button>
              </label>
              <input type="email" class="form-control" [(ngModel)]="formData.email">
            </div>
          </div>

          <!-- Row 12 -->
          <div class="mb-3">
            <label class="d-flex align-items-center" style="cursor: pointer; margin-bottom: 0;">
              <input class="me-2" type="checkbox" id="collaborateCheckbox" [(ngModel)]="formData.collab"
                     style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
              <span>I'm open to collaborate with the community</span>
            </label>
          </div>

          <!-- Row 13 -->
          <hr style="border: 0; border-top: 1px solid #adb5bd; margin: 1rem -1.5rem;">

          <!-- Error Message -->
          @if (submitError()) {
            <div class="alert alert-danger mb-3" role="alert">
              {{ submitError() }}
            </div>
          }

          <!-- Row 14 -->
          <div class="d-flex justify-content-between">
            <button type="button" class="btn" style="color: #0d6efd; background-color: #fff; border: none;" (click)="closeRequestModal()" [disabled]="isSubmitting()">Cancel</button>
            <button type="button" class="btn" style="color: #fff; background-color: #0d6efd;" (click)="submitRequest()" [disabled]="isSubmitting() || !formData.integrationApplicationName || !formData.description">
              {{ isSubmitting() ? 'Submitting...' : 'Submit Request' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
}
